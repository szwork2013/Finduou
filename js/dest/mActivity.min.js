
function initMap(){var a={lat:maplot,lng:maplng},b=new google.maps.Map(document.getElementById("map"),{center:{lat:maplot,lng:maplng},zoom:15}),c=new google.maps.Marker({position:a,map:b,title:"Hello World!"}),d=new google.maps.InfoWindow;d.setContent("<div><strong>"+$("#address-input-write").val()+"</strong><br>"),d.open(b,c);var e=document.getElementById("address-input-write"),f=new google.maps.places.Autocomplete(e);f.bindTo("bounds",b);var g=new google.maps.InfoWindow,h=new google.maps.Marker({map:b,anchorPoint:new google.maps.Point(0,-29)});f.addListener("place_changed",function(){d.close(),g.close(),h.setVisible(!1);var a=f.getPlace();if(!a.geometry)return void window.alert("Autocomplete's returned place contains no geometry");c.setMap(null),locate.address=a.formatted_address,locate.place_id=a.place_id,locate.lat=a.geometry.location.lat(),locate.lng=a.geometry.location.lng(),a.geometry.viewport?b.fitBounds(a.geometry.viewport):(b.setCenter(a.geometry.location),b.setZoom(17)),h.setPosition(a.geometry.location),h.setVisible(!0);var e="";a.address_components&&(e=[a.address_components[0]&&a.address_components[0].short_name||"",a.address_components[1]&&a.address_components[1].short_name||"",a.address_components[2]&&a.address_components[2].short_name||""].join(" ")),g.setContent("<div><strong>"+a.name+"</strong><br>"+e),g.open(b,h)})}$(function(){(""==strdecode(getCookie("token"))||void 0==strdecode(getCookie("token"))||-1==strdecode(getCookie("token")))&&(window.location.href="index.html"),$("#header-right").find("span").eq(2).click(function(a){$("#nav-list").toggle(),a.stopPropagation()}),$(document).click(function(a){$("#active-type-select").hide(),$("#active-status-select").hide(),$("#nav-list").hide(),$("#city-select").hide()}),$("#nav-list").find("li").eq(0).click(function(a){window.location.href="index.html#resetPwd"}),$("#nav-list").find("li").eq(1).click(function(a){removeCookie("email"),removeCookie("id"),removeCookie("pwd"),removeCookie("token"),window.location.href="index.html"}),$(".city-wrap").click(function(a){$("#city-select").toggle(),a.stopPropagation()}),$("#city-select").find("li").click(function(a){$("#city-select").siblings("span").html($(this).html())}),$(".wrap").click(function(a){$(this).next().toggle(),a.stopPropagation()}),$("#active-type-select").find("li").click(function(a){$("#active-type-select").prev().find("span").html($(this).html())}),$("#active-status-select").find("li").click(function(a){$("#active-status-select").prev().find("span").html($(this).html())}),$("#upbtn").click(function(a){$("#upload").click()});var a="",b=new FormData;$("#upload").change(function(b){var c=/[\.](jpg|gif|png|JPG|PNG|GIF|jpeg)$/;if(null==b.target.files[0].name.match(c))return alert("文件格式不正确"),!1;if(b.target.files[0].size>4243e5)return alert("图片不能超过4M"),!1;var d=new FileReader;d.readAsDataURL(b.target.files[0]),d.onload=function(c){var d=new Image;d.src=this.result,d.onload=function(){900!=this.width&&500!=this.height?$("#poster-tip").html("图片尺寸900*500").show():(a=b.target.files[0],$(".photoframe").html(this),$("#poster-tip").hide())}}});var c=getaId();$.ajax({url:basic.topAddress+basic.subAddress+"circle_activityWS.asmx/GetOne?jsoncallback=?",type:"GET",dataType:"jsonp",data:{id:c}}).done(function(b){b.error&&(alert(b.error),window.location.href="index.html"),$("#title-input-write").val(strdecode(b.Head[0].title)),$("#d422").val(strdecode(b.Head[0].set_date).split(" ")[0]),$("#d242").val(strdecode(b.Head[0].set_time_s)),$("#d243").val(strdecode(b.Head[0].set_time_e)),$("#address-input-write").val(strdecode(b.Head[0].place));var c=""==strdecode(b.Head[0].type)?"全部":strdecode(b.Head[0].type);$(".city-wrap").children("span").html(strdecode(b.Head[0].city)),$("#active-type-select").prev().find("span").html(c),$("#active-status-select").prev().find("span").html(strdecode(b.Head[0].state)),$(".photoframe").html("<img src='"+basic.topAddress+basic.webAddress+strdecode(b.Head[0].poster)+"' />"),$("#activity-intro").val(strdecode(b.Head[0].content).replace(/(&nbsp)/g," ").replace(/(&brbr&)/g,"\n")),$("#question").val(strdecode(b.Head[0].question)),a=strdecode(b.Head[0].poster),maplng=parseFloat(strdecode(b.Head[0].longitude)),maplot=parseFloat(strdecode(b.Head[0].latitude)),locate.lng=parseFloat(strdecode(b.Head[0].longitude)),locate.lat=parseFloat(strdecode(b.Head[0].latitude)),locate.address=strdecode(b.Head[0].place),locate.place_id=strdecode(b.Head[0].place_id),$("html").append($("<script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyAslXLzbetaH41cOt6sBGsG4rW5W1FEb94&libraries=places&callback=initMap'async defer>"))}).fail(function(){}),$("#cancel").click(function(a){$.ajax({url:basic.topAddress+basic.subAddress+"circle_activityWS.asmx/Delete?jsoncallback=?",type:"GET",dataType:"jsonp",data:{id:c,USER:"",TOKEN:getCookie("token")}}).done(function(){b.error?(alert(b.error),window.location.href="index.html"):(alert("删除成功"),window.location.href="activeList.html")}).fail(function(){console.log("error")})});var d=/[@#\$%\^&\*<>]+/g;$("#save").click(function(e){var f=!1;return $("#title-input-write").val().length>30?($("#title-input-write").next().html("标题过长 &nbsp &nbsp &nbsp &nbsp &nbsp").show(),f=!0):""==$("#title-input-write").val()?($("#title-input-write").next().html("请输入活动标题").show(),f=!0):d.test($("#title-input-write").val())?($("#title-input-write").next().html("非法输入 &nbsp &nbsp &nbsp &nbsp &nbsp").show(),f=!0):$("#title-input-write").next().hide(),""==$("#d422").val()||""==$("#d242").val()||""==$("#d243").val()?($("#d243").next().show(),f=!0):d.test($("#d422").val())||d.test($("#d242").val())||d.test($("#d243").val())?($("#d243").next().show(),f=!0):$("#d243").next().hide(),"请选择"==$(".city-wrap").find("span").html()?($(".city-wrap").css("borderColor","#f00"),f=!0):$(".city-wrap").css("borderColor","#cacaca"),""==$("#address-input-write").val()?($("#address-input-write").next().show(),f=!0):d.test($("#address-input-write").val())?($("#address-input-write").next().show(),f=!0):$("#address-input-write").next().hide(),"请选择"==$("#active-type-select").prev().find("span").html()?($("#active-type-select").prev().css("borderColor","#f00"),f=!0):$("#active-type-select").prev().css("borderColor","#cacaca"),"请选择"==$("#active-status-select").prev().find("span").html()?($("#active-status-select").prev().css("borderColor","#f00"),f=!0):$("#active-status-select").prev().css("borderColor","#cacaca"),""==$("#activity-intro").val()?($("#activity-intro").next().show(),f=!0):$("#activity-intro").val().length>300||$("#activity-intro").val().length<10?($("#activity-intro").next().show(),f=!0):d.test($("#activity-intro").val())?($("#activity-intro").next().show(),f=!0):($("#activity-intro").next().hide(),str=$("#activity-intro").val()),d.test($("#question").val())&&(f=!0,alert("报名问题不能含有非法字符")),f?!1:(b.append("id",c),b.append("circle_id",""),b.append("university_id",strdecode(getCookie("uid"))),b.append("type",$("#active-type-select").prev().find("span").html()),b.append("state",$("#active-status-select").prev().find("span").html()),b.append("title",$("#title-input-write").val()),b.append("set_date",$("#d422").val()),b.append("set_time_s",$("#d242").val()),b.append("set_time_e",$("#d243").val()),b.append("city",$("#city-select").siblings("span").html()),b.append("place",locate.address),b.append("longitude",locate.lng),b.append("latitude",locate.lat),b.append("place_id",locate.place_id),b.append("content",str),b.append("number",""),b.append("contact_flag",""),b.append("poster",a),b.append("creater",strdecode(getCookie("id"))),b.append("question",$("#question").val()),b.append("USER",strdecode(getCookie("USER"))),b.append("TOKEN",strdecode(getCookie("token"))),void $.ajax({url:basic.topAddress+basic.webAddress+"/UploadActivityPic.aspx",type:"POST",data:b,cache:!1,contentType:!1,processData:!1,success:function(a){a.error?(alert(a.error),window.location.href="index.html"):(alert("修改活动成功"),window.location.href="activeList.html")},error:function(a){alert(a.status+"失败")}}))})});